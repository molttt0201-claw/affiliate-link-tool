<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>è¯ç›Ÿç¶²é€£çµå·¥å…·</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .container { max-width: 480px; margin: 0 auto; }
        h1 { font-size: 1.5rem; font-weight: bold; color: #1f2937; text-align: center; margin-bottom: 0.5rem; }
        .subtitle { color: #4b5563; text-align: center; margin-bottom: 2rem; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
        input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        button {
            width: 100%;
            padding: 0.75rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }
        button:disabled { background: #9ca3af; }
        .success { background: #ecfdf5; color: #059669; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; }
        .error { background: #fef2f2; color: #dc2626; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .result { background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .result-url { 
            background: white; 
            padding: 0.75rem; 
            border-radius: 6px; 
            border: 1px solid #bbf7d0; 
            font-size: 0.875rem; 
            word-break: break-all; 
            margin-bottom: 0.75rem;
        }
        .btn-green { background: #22c55e; }
        .btn-green:hover { background: #16a34a; }
        .brands-count { text-align: center; font-size: 0.875rem; color: #6b7280; margin-top: 1.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— è¯ç›Ÿç¶²é€£çµå·¥å…·</h1>
        <p class="subtitle">å¿«é€Ÿå°‡ç¶²å€è½‰æ›ç‚ºè¿½è¹¤é€£çµ</p>

        <!-- API Key è¨­å®š -->
        <div class="card">
            <div class="card-title">API Key</div>
            <div id="apiSection">
                <input type="text" id="apiKeyInput" placeholder="è¼¸å…¥æ‚¨çš„ API Key">
                <button id="saveApiKey" onclick="saveApiKey()">é©—è­‰ä¸¦å„²å­˜</button>
            </div>
            <div id="apiStatus" style="display:none;" class="success"></div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMsg" class="error" style="display:none;"></div>

        <!-- è½‰æ›å·¥å…· -->
        <div class="card" id="convertSection" style="display:none;">
            <div class="card-title">ç¶²å€è½‰æ›</div>
            <input type="url" id="urlInput" placeholder="https://www.nike.com/tw/...">
            <button onclick="convertUrl()">è½‰æ›ç‚ºè¿½è¹¤é€£çµ</button>
            
            <div id="result" class="result" style="display:none;">
                <div style="font-weight:500; color:#166534; margin-bottom:0.5rem;">è½‰æ›çµæœï¼š</div>
                <div class="result-url" id="resultUrl"></div>
                <button class="btn-green" id="copyBtn" onclick="copyResult()">ğŸ“‹ è¤‡è£½é€£çµ</button>
            </div>
        </div>

        <div id="brandsCount" class="brands-count"></div>
    </div>

    <script>
        const API_BASE = 'https://api.pub.affiliates.one/api/v2';
        let brandDomains = {};

        // å¾ URL æå–ç¶²åŸŸ
        function extractDomain(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.replace(/^www\./, '');
            } catch {
                return null;
            }
        }

        // å„²å­˜ API Key
        async function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const errorDiv = document.getElementById('errorMsg');
            const statusDiv = document.getElementById('apiStatus');
            const convertSection = document.getElementById('convertSection');
            const saveBtn = document.getElementById('saveApiKey');
            
            errorDiv.style.display = 'none';
            saveBtn.textContent = 'é©—è­‰ä¸­...';
            saveBtn.disabled = true;

            if (!apiKey) {
                showError('è«‹è¼¸å…¥ API Key');
                saveBtn.textContent = 'é©—è­‰ä¸¦å„²å­˜';
                saveBtn.disabled = false;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/affiliates/offers.json?api_key=${apiKey}&approval_statuses=Active&per_page=500&locale=zh-TW`);
                
                if (!response.ok) {
                    throw new Error('API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key');
                }
                
                const data = await response.json();
                
                if (!data.data || data.data.length === 0) {
                    // å˜—è©¦ä¸ç¯©é¸
                    const response2 = await fetch(`${API_BASE}/affiliates/offers.json?api_key=${apiKey}&per_page=500&locale=zh-TW`);
                    const data2 = await response2.json();
                    
                    if (!data2.data || data2.data.length === 0) {
                        throw new Error('API Key ç„¡æ•ˆæˆ–ç„¡æ³•å–å¾—å“ç‰Œè³‡æ–™');
                    }
                    
                    localStorage.setItem('affiliate_api_key', apiKey);
                    statusDiv.textContent = 'API Key é©—è­‰æˆåŠŸï¼Œä½†å°šæœªç”³è«‹ä»»ä½•å“ç‰Œ';
                    statusDiv.style.display = 'block';
                    saveBtn.textContent = 'é©—è­‰ä¸¦å„²å­˜';
                    saveBtn.disabled = false;
                    return;
                }

                // å»ºç«‹ç¶²åŸŸå°ç…§è¡¨
                brandDomains = {};
                data.data.forEach(brand => {
                    const domain = extractDomain(brand.preview_url);
                    if (domain && brand.tracking_link) {
                        brandDomains[domain] = {
                            name: brand.name,
                            trackingLink: brand.tracking_link
                        };
                    }
                });

                localStorage.setItem('affiliate_api_key', apiKey);
                statusDiv.textContent = `âœ… å·²è¼‰å…¥ ${data.data.length} å€‹å“ç‰Œ`;
                statusDiv.style.display = 'block';
                document.getElementById('apiSection').style.display = 'none';
                convertSection.style.display = 'block';
                document.getElementById('brandsCount').textContent = `å·²è¼‰å…¥ ${data.data.length} å€‹å“ç‰Œ`;
                
            } catch (err) {
                showError(err.message || 'API Key é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèª Key æ˜¯å¦æ­£ç¢º');
                saveBtn.textContent = 'é©—è­‰ä¸¦å„²å­˜';
                saveBtn.disabled = false;
            }
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
        }

        // è½‰æ›ç¶²å€
        function convertUrl() {
            const inputUrl = document.getElementById('urlInput').value.trim();
            const resultDiv = document.getElementById('result');
            const resultUrl = document.getElementById('resultUrl');
            
            document.getElementById('errorMsg').style.display = 'none';
            resultDiv.style.display = 'none';

            if (!inputUrl) {
                showError('è«‹è¼¸å…¥ç¶²å€');
                return;
            }

            const inputDomain = extractDomain(inputUrl);
            
            if (!inputDomain) {
                showError('ç„¡æ•ˆçš„ç¶²å€æ ¼å¼');
                return;
            }

            const brandInfo = brandDomains[inputDomain];
            
            if (!brandInfo) {
                showError(`âš ï¸ "${inputDomain}" ä¸åœ¨æ‚¨å·²ç”³è«‹çš„å“ç‰Œåˆ—è¡¨ä¸­`);
                return;
            }

            const trackingLink = brandInfo.trackingLink;
            const encodedUrl = encodeURIComponent(inputUrl);
            const finalUrl = `${trackingLink}&t=${encodedUrl}`;

            resultUrl.textContent = finalUrl;
            resultDiv.style.display = 'block';
            document.getElementById('copyBtn').textContent = 'ğŸ“‹ è¤‡è£½é€£çµ';
        }

        // è¤‡è£½çµæœ
        async function copyResult() {
            const resultUrl = document.getElementById('resultUrl').textContent;
            try {
                await navigator.clipboard.writeText(resultUrl);
                document.getElementById('copyBtn').textContent = 'âœ… å·²è¤‡è£½ï¼';
            } catch {
                showError('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            }
        }

        // è¼‰å…¥å·²å„²å­˜çš„ API Key
        window.onload = function() {
            const savedKey = localStorage.getItem('affiliate_api_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
                saveApiKey();
            }
        };
    </script>
</body>
</html>
